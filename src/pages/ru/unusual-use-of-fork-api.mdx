---
title: –ù–µ–æ–±—ã—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Fork API
description: –ö–∞–∫ –µ—â–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Fork API –µ—Å–ª–∏ –Ω–µ SSR –∏–ª–∏ —Ç–µ—Å—Ç—ã?
date: 2022-09-18
language: ru
layout: ../../layouts/MarkdownLayout.astro
---

# Table of Contents

# –í–≤–µ–¥–µ–Ω–∏–µ

–ö–æ–≥–¥–∞ –∑–∞—Ö–æ–¥–∏—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ fork API, –æ–±—ã—á–Ω–æ –≤—Å–ø–æ–º–∏–Ω–∞—é—Ç —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏. –í —ç—Ç–æ–π
—Å—Ç–∞—Ç—å–µ —Å–ø–µ—à—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π —Å–ø–µ–∫—Ç—Ä –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–π —ç—Ç–æ–≥–æ API.

# –î–∞ –∫—Ç–æ —Ç–∞–∫–æ–π —ç—Ç–æ—Ç –≤–∞—à Fork API

<p class="p-0 text-[3em]">üî®</p>

## –ü—Ä–æ–±–ª–µ–º–∞

[effector]: https://effector.dev

–û–±—ã—á–Ω–æ [effector][effector] —Ö—Ä–∞–Ω–∏—Ç –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–≤ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ `createStore`. –•—É–∫–∏
React –∏–ª–∏ SolidJS –≤—ã—Ç–∞—Å–∫–∏–≤–∞—é—Ç
–∑–Ω–∞—á–µ–Ω–∏–µ [–Ω–∞–ø—Ä—è–º—É—é –∏–∑ —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞](https://github.com/effector/effector/blob/88d721a0a0279109e4a45ba79568b5197152b080/src/react/apiBase.ts#L10)
–ø–æ —Å—Å—ã–ª–∫–µ.

```tsx
const $name = createStore('Sergey Sova');

function Component() {
  const name = useStore($name);
  return <div>Name: {name}</div>;
}
```

–í —Å–ª—É—á–∞–µ —Å SSR, –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–µ—Ä–≤–µ—Ä—É –Ω—É–∂–Ω–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–¥–∞–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ö–∞–∫ –º—ã –ø–æ–º–Ω–∏–º Node.JS/Deno/Bun ‚Äî –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–∞—è —Å—Ä–µ–¥–∞, –Ω–æ –∑–∞ —Å—á–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ —É–¥–∞–µ—Ç—Å—è –¥–æ–±–∏—Ç—å—Å—è —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ–º–æ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è. –ü–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–µ–Ω—Ç–∞ –ê –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ HTTP-–∑–∞–ø—Ä–æ—Å–∞, —Å–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–æ–≤ –ë –∏–ª–∏ –í.

–ú—ã –Ω–µ –º–æ–∂–µ–º –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –ª–æ–≥–∏–∫–∏, –≤–µ–¥—å [—ç—Ñ—Ñ–µ–∫—Ç—ã](https://effector.dev/ru/docs/api/effector/effect) –±—É–∫–≤–∞–ª—å–Ω–æ —è–≤–ª—è—é—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏. –î–æ–≤–æ–ª—å–Ω–æ –ª–µ–≥–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–µ–±–µ —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ _–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π_ –¥–æ—Å—Ç—É–ø —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –æ–±—â–µ–≥–æ —Å—Ç–æ—Ä–∞ –º–æ–∂–µ—Ç –≤—Å–µ —Å–ª–æ–º–∞—Ç—å.

–ü–æ–∫–∞ —É –Ω–∞—Å –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —ç—Ç–∏–º–∏ —Å—Ç–æ—Ä–∞–º–∏, –≤—Å–µ –æ–∫–µ–π.

```ts
const reset = createEvent();
const run = createEvent();

const waitFx = createEffect(() => {
  return new Promise((resolve) => setTimeout(resolve, 100));
});

const $counter = createStore([]);

$counter.reset(reset);

$counter.on(run, (list, name) => [...list, `manual ${name}`]);

sample({
  clock: run,
  target: waitFx,
});

$counter.on(waitFx.done, (list, {params: name}) => [
  ...list,
  `fx done ${name}`,
]);

$counter.watch((i) => console.log('counter', i));
// counter []

run('A');
// counter ["manual A"]

run('B');
// counter ["manual A", "manual B"]

// counter ["manual A", "manual B", "fx done A"]
// counter ["manual A", "manual B", "fx done A", "fx done B"]
```

[Playground](https://share.effector.dev/5oBljPUk)

–î–æ–ø—É—Å—Ç–∏–º `run('A')` –∏ `run('B')` —ç—Ç–æ –≤—ã–∑–æ–≤—ã —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤. –ó–¥–µ—Å—å –Ω–∞–≥–ª—è–¥–Ω–æ –≤–∏–¥–Ω–æ, —á—Ç–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç—Å—è –æ–±—â–∏–π –º–∞—Å—Å–∏–≤, –∏ –≤ –∏—Ç–æ–≥–µ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç —Å–º–µ—à–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –ï—Å–ª–∏ –±—ã —ç—Ç–æ –±—ã–ª —Å—Ç–æ—Ä —Å –æ–±—ã—á–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, —Ç–æ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞–ª–∏ –±—ã —á—É–∂–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í—ã–∑–æ–≤ –∏–≤–µ–Ω—Ç–∞ `reset` –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ –Ω–∏–∫–∞–∫ –Ω–µ —Å–ø–∞—Å–µ—Ç —Å–∏—Ç—É–∞—Ü–∏—é:

```ts
run('A');
// counter ["manual A"]

reset();
// counter []

run('B');
// counter ["manual B"]

// counter ["manual B", "fx done A"]
// counter ["manual B", "fx done A", "fx done B"]
```

[Playground](https://share.effector.dev/6bzTKXwA)

–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –ø–æ—Ç–µ—Ä—è–Ω–æ –æ–¥–Ω–æ –∏–∑ –∑–Ω–∞—á–µ–Ω–∏–π –º–∞—Å—Å–∏–≤–∞, —Ç–æ–≥–¥–∞ –∫–∞–∫ `"fx done A"` –≤—Å–µ –µ—â–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω.

## –†–µ—à–µ–Ω–∏–µ

–ê —á—Ç–æ –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–µ—Å—Ç–µ?

```ts
// –ü—Å–µ–≤–¥–æ–∫–æ–¥
const clientA = {stores: new Map()};
const clientB = {stores: new Map()};

// –ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç A –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–≤–æ–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è,
// —á–∏—Ç–∞—Ç—å –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–≤ –≤ –æ–±—ä–µ–∫—Ç clientA

run('A');
clientA.stores.set($counter, ['manual A']);
```

–ü—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç fork API. –° –ø–æ–º–æ—â—å—é –≤—ã–∑–æ–≤–∞ `fork()` –º—ã —Å–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç ‚Äî scope, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–≤. –ò–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ, –≤ SSR –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã React –∏–ª–∏ SolidJS –≤ `Provider`.

```tsx
const scope = fork();

export function Init() {
  return (
    <Provider value={scope}>
      <App />
    </Provider>
  );
}
```

–ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤ —Å–∫–æ—É–ø–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `allSettled` –∏–ª–∏ [`useEvent`](https://effector.dev/ru/docs/api/effector-react/useEvent):

```ts
await allSettled(run, {
  scope,
  params: 'A',
});
```

[Playground](https://share.effector.dev/h9rENxUp)

–†–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ:
—é–Ω–∏—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤ `allSettled` –ø–µ—Ä–≤—ã–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å–µ–±–µ —Å—Å—ã–ª–∫—É –Ω–∞ `scope`, —Å—Ç–æ—Ä—ã –ø—Ä–æ—á–∏—Ç–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –µ—â–µ –Ω–µ –±—ã–ª–æ, –∏—Å–ø–æ–ª—å–∑—É—é—Ç `.defaultState`, –∏ –∑–∞–ø–∏—à—É—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ scope. –≠—Ñ—Ñ–µ–∫—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —á—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ, –≤–µ–¥—å –≤ –Ω–∏—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ scope –º–µ–∂–¥—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏, –Ω–æ –∏–¥–µ—è –¥—É–º–∞—é –ø–æ–Ω—è—Ç–Ω–∞.

# –ö–∞–∫ –µ—â–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

import {Image} from 'astro:assets';

–Ø —Ä–µ—à–∏–ª —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∏–≥—Ä—ã —Å –¥—Ä—É–∑—å—è–º–∏ –≤ [–Ω–∞—Å—Ç–æ–ª–∫—É](https://munchkin.game/) ‚Äî Munchkin level counter. –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º—É –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é](https://web.allmunchkins.com/) —Å —ç—Ñ—Ñ–µ–∫—Ç–æ—Ä–æ–º –∏ –≤–µ–±—Å–æ–∫–µ—Ç–∞–º–∏.

–°—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞—Ö:

–ò–≥—Ä–∞ ‚Äî –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ –≤–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ò–≥—Ä–æ–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—É, –∑–∞—Ö–æ–¥—è—Ç –≤ –æ–±—â—É—é –∫–æ–º–Ω–∞—Ç—É, –≤–∏–¥—è—Ç —Å—á–µ—Ç –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤, –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —Å–≤–æ–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç —á–µ–π —Å–µ–π—á–∞—Å —Ö–æ–¥ –∏ –ø–æ–ª—É—á–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

import munchkin1 from './munchkin/1.png';

<Image
  src={munchkin1}
  widths={[420, 680, 820, 1600]}
  formats={['avif', 'jpeg', 'png', 'webp']}
  alt="–°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç"
/>

–í –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å —Å–≤–æ—è –ª–æ–≥–∏–∫–∞, –Ω–µ –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω–∞—è, –Ω–æ –∏–º–µ–µ—Ç—Å—è: —è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–æ–¥–∞, –ø–æ–¥—Å—á–µ—Ç –æ—á–∫–æ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –æ—á–∫–æ–≤ –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –Ω–µ –ø–æ–∑–≤–æ–ª—è—é –æ–ø—É—Å—Ç–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–∏–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ. –ú–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Å—á–∏—Ç–∞—Ç—å –≤—Å–µ —ç—Ç–æ —É –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ, –Ω–æ —è –æ—á–µ–Ω—å –Ω–µ —Ö–æ—Ç–µ–ª –∑–∞–º–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –∏–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å [CRDT](https://crdt.tech/). –ü–ª—é—Å, –∏–≥—Ä–æ–∫–∏ –Ω–µ –≤—Å–µ–≥–¥–∞ —Ö–æ—Ç—è—Ç –¥–µ—Ä–∂–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –æ—Ç–∫—Ä—ã—Ç–æ–π –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω—É–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –∏–≥—Ä—ã.

import munchkin2 from './munchkin/2.png';

<Image
  src={munchkin2}
  widths={[420, 680, 820, 1600]}
  formats={['avif', 'jpeg', 'png', 'webp']}
  alt="–ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ"
/>

–°—Ä–∞–∑—É –æ–≥–æ–≤–æ—Ä—é—Å—å, —á—Ç–æ —è –Ω–µ –±–æ—Ä—é—Å—å –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –¥—Ä—É–∑–µ–π. –¢–æ—á–Ω–æ —Ç–∞–∫ –∂–µ —è –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞—é –æ –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö, –≤–µ–¥—å –±–æ–ª—å—à–µ 6 –∏–≥—Ä–æ–∫–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ –æ–±—ã—á–Ω–æ –Ω–µ –±—ã–≤–∞–µ—Ç. –í–æ–∑–º–æ–∂–Ω–æ, –≤ –±—É–¥—É—â–µ–º —è –¥–æ–±–∞–≤–ª—é –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –Ω–æ —Å–µ–π—á–∞—Å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–∞–∂–µ –Ω–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –∑–∞—à–µ–ª –∏ –∏–≥—Ä–∞–µ—à—å.

–ö–∞–∫ –∏–º–µ–Ω–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —è —Å–Ω–∞—á–∞–ª–∞ –Ω–µ –∑–Ω–∞–ª, –Ω–æ –º–Ω–µ –ø—Ä–∏—à–ª–∞ –≤ –≥–æ–ª–æ–≤—É —Ç–∞–∫–∞—è —Å—Ö–µ–º–∞: –∏–≥—Ä–æ–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≤–µ–±—Å–æ–∫–µ—Ç-—Å–æ–±—ã—Ç–∏—è –≤ –∫–æ–º–Ω–∞—Ç—É ‚Äî —è –Ω–∞–∂–∞–ª —Ç–æ-—Ç–æ, –∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∏–º –ø–æ –≤–µ–±—Å–æ–∫–µ—Ç–∞–º –ø–æ–ª–Ω–æ–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∫–∞–∫ –æ–Ω–æ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è.

–ò –µ—Å–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —ç—Ç—É —Å—Ö–µ–º—É –≤ —Ç–µ—Ä–º–∏–Ω–∞—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ—Ä–∞, —Ç–æ –≤–∏–¥–Ω–æ –æ—á–µ–Ω—å –ø–æ–Ω—è—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —Å–µ—Ä–≤–µ—Ä –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å –º–æ–¥–µ–ª–∏ ‚Äî —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

## –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–æ

–Ø –≤—ã–¥–µ–ª–∏–ª –≤—Å—é –ª–æ–≥–∏–∫—É –∏–≥—Ä—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –∏ –Ω–∞–ø–∏—Å–∞–ª –Ω–∞ –Ω–µ—ë —Ç–µ—Å—Ç—ã, –∫–∞–∫ –¥–ª—è –æ–±—ã—á–Ω–æ–π –º–æ–¥–µ–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```ts
test('player can grow level', async () => {
  const scope = fork();
  await allSettled(munchkin.playerJoined, {scope, params: John});
  await allSettled(munchkin.playerJoined, {scope, params: Alba});

  await allSettled(munchkin.levelUp, {scope, params: John.id});
  expect(scope.getState(munchkin.$players)).toStrictEqual([
    {...John, level: 2},
    Alba,
  ]);
});

test('player can lose level', async () => {
  const scope = fork();
  await allSettled(munchkin.playerJoined, {scope, params: John});
  await allSettled(munchkin.playerJoined, {scope, params: Alba});

  await allSettled(munchkin.levelUp, {scope, params: John.id});
  await allSettled(munchkin.levelDown, {scope, params: John.id});
  expect(scope.getState(munchkin.$players)).toStrictEqual([John, Alba]);
});
```

[–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ `munchkin.ts`](https://gist.github.com/sergeysova/14318b49f81c692234f05dd6f786c33c)

–ö–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä? –ú–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Å–¥–µ–ª–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è—é—â–∏–π type –∏ payload –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –≥–¥–µ –º—ã —á–µ—Ä–µ–∑ switch/case –±—É–¥–µ–º –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∏–≤–µ–Ω—Ç –º–æ–¥–µ–ª–∏ –∏ –≤—ã–∑—ã–≤–∞—Ç—å —Å payload.

```jsx
// client
const stepFinishedFx = createEffect(() => sendWSEvent({type: 'stepFinished'}));
const gearIncreaseFx = createEffect(() => sendWSEvent({type: 'gearIncrease'}));
const gearDecreaseFx = createEffect(() => sendWSEvent({type: 'gearDecrease'}));
const deadFx = createEffect(() => sendWSEvent({type: 'dead'}));
const levelUpFx = createEffect(() => sendWSEvent({type: 'levelUp'}));

// server
const {type, value} = JSON.parse(message.toString());
switch (type) {
  case 'gameEvent': {
    const {type: gameType, payload} = value;
    switch (gameType) {
      case 'stepFinished': {
        const player = getCurrentPlayer();
        const room = player.getRoom();
        gameFinished(); // Bang!
        sendUpdates();
        break;
      }
    }
  }
}
```

–ù–æ –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–∏—à–∫–æ–º –º—É—Ç–æ—Ä–Ω–æ, –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —é–Ω–∏—Ç–æ–≤ –ø—Ä–∏–¥–µ—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–¥ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞.

–ê —á—Ç–æ, –µ—Å–ª–∏ —è –±—É–¥—É –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —Ç–µ –∂–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ –º–æ–¥–µ–ª–∏ –∏–≥—Ä—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –∑–∞—Å—Ç–∞–≤–ª—é —ç—Ñ—Ñ–µ–∫—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –≥–¥–µ –±—É–¥—É –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏—Ö –≤ –Ω—É–∂–Ω—É—é –∫–æ–º–Ω–∞—Ç—É –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è?

–î–ª—è —ç—Ç–æ–≥–æ —è –≤—ã–¥–µ–ª–∏–ª –Ω–∞–±–æ—Ä –ø—É–±–ª–∏—á–Ω—ã—Ö –∏–≤–µ–Ω—Ç–æ–≤ –∏–∑ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª, –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª –µ–≥–æ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥.

```tsx
// common
export const common = createDomain();

export const levelUp = common.createEvent<Uuid>();
export const levelDown = common.createEvent<Uuid>();
export const playerKill = common.createEvent<Uuid>();

export const gearIncrease = common.createEvent<Uuid>();
export const gearDecrease = common.createEvent<Uuid>();
export const gearReset = common.createEvent<Uuid>();

export const $gameMode = common.createStore<GameMode>('common');
export const $players = common.createStore<Player[]>([]);
```

–î–ª—è —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –±–∞–Ω–¥–ª–∞ –±—É–¥—É—Ç –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ sid'—ã –∫–∞–∂–¥–æ–º—É —Å—Ç–æ—Ä—É. –í–µ–¥—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Ñ–∞–π–ª–∞ –Ω–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–ª–∏–µ–Ω—Ç–∞. SID ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —é–Ω–∏—Ç–∞, –∑–∞–≤–∏—Å—è—â–∏–π –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –æ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è —é–Ω–∏—Ç–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ –ø—Ä–æ–µ–∫—Ç–∞.

> –°–æ–≤–µ—Ç: —á—Ç–æ–±—ã –±—ã–ª–æ –ø—Ä–æ—â–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∏–º–µ–Ω–∞ –∏–≤–µ–Ω—Ç–æ–≤ –∏ —Å—Ç–æ—Ä–æ–≤ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –ø–æ websocket, –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–ø—Ü–∏—é `debugSids: true` –≤ `effector/babel-plugin`.

–ó–∞—Ç–µ–º, —Å –ø–æ–º–æ—â—å—é –¥–æ–º–µ–Ω–∞ –ø—Ä–æ—à–µ–ª—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å–æ–±—ã—Ç–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª –≤—ã–∑–æ–≤ —Å–æ–±—ã—Ç–∏—è –≤ —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

```tsx
// client
munchkin.common.onCreateEvent((event) => {
  sample({
    clock: event,
    fn: (payload) => ({sid: event.sid, payload}),
    target: sendGameEventFx,
  });
});
```

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—Å–µ –≥–æ—Ä–∞–∑–¥–æ –ø—Ä–æ—â–µ, –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ, —è –Ω–∞—Ö–æ–∂—É –≤ –æ–±—ä–µ–∫—Ç–µ —Å–æ–±—ã—Ç–∏–µ —Å –Ω—É–∂–Ω—ã–º `.sid` –∏ –≤—ã–∑—ã–≤–∞—é –µ–≥–æ –Ω–∞ —Å–∫–æ—É–ø–µ –∫–æ–º–Ω–∞—Ç—ã —á–µ—Ä–µ–∑ `allSettled`.

```tsx
import * as munchkin from '../common/munchkin';

switch (type) {
  case 'gameEvent': {
    const {sid, payload} = value;
    const room = getRoomOfPlayer(me);
    if (room) {
      for (const unit of munchkin.common.history.events) {
        if (unit.sid === sid) {
          await allSettled(unit, {
            scope: room.scope,
            params: payload,
          });
        }
      }
    }
    break;
  }
  // ...
}
```

## –°–∫–æ—É–ø—ã –∫–æ–º–Ω–∞—Ç

–ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É, —è —Å—Ä–∞–∑—É –∂–µ –≤—ã–ø–æ–ª–Ω—è—é `fork()` –∏ —Å–æ—Ö—Ä–∞–Ω—è—é —Å—Å—ã–ª–∫—É –≤ –æ–±—ä–µ–∫—Ç–µ –∫–æ–º–Ω–∞—Ç—ã.

```tsx
function roomCreate(id: string): Room {
  const room = {
    id,
    name: sentenceCase(createRoomName()),
    teammates: [],
    scope: fork(),
  };
}
```

–ö–æ–Ω–µ—á–Ω–æ –∂–µ, –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –º–Ω–µ –Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã —Ç–µ—Ä—è—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–≥—Ä—ã, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –º—ã —Å –¥—Ä—É–∑—è–º–∏ –¥–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É –ø–æ–∑–∂–µ.

–ü–æ—ç—Ç–æ–º—É –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–≥—Ä—ã –Ω–∞ –¥–∏—Å–∫, —è –≤—ã–ø–æ–ª–Ω—è—é —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞–∂–¥–æ–≥–æ —Å–∫–æ—É–ø–∞. –ó–∞—Ç–µ–º, –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑ –¥–∏—Å–∫–∞, —è –∑–∞–≥—Ä—É–∂–∞—é –≤ —Å–∫–æ—É–ø –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–¥–∞—á—É –≤ values.

```tsx
// backup
const gameState = serialize(room.scope);

// restore
room.scope = fork({values: backup.gameState});
```

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: —ç—Ç–æ—Ç —Ç—Ä—é–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∂–∞—Ç—å —Å –¥–∏—Å–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –∏–≥—Ä—ã. –¢–æ–≥–¥–∞ –ø–æ–º–µ–Ω—è—é—Ç—Å—è sid'—ã —Å—Ç–æ—Ä–æ–≤. –ü–æ —Ö–æ—Ä–æ—à–µ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º.

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–ª–µ—Ç–µ–ª–æ, —è –æ—Ç–ø—Ä–∞–≤–ª—è—é –µ–≥–æ –≤ —Å–∫–æ—É–ø –∫–æ–º–Ω–∞—Ç—ã, —Ç–∞–º –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ—Ä–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–æ—Ä—ã:

```tsx
// ...
await allSettled(unit, {scope: room.scope, params: payload});
// ...
```

–¢–µ–ø–µ—Ä—å –º–Ω–µ –Ω–∞–¥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Å—Ç–æ—Ä—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä, –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É.

–î–ª—è —ç—Ç–æ–≥–æ —è –¥–æ–±–∞–≤–∏–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ –∫–æ–º–Ω–∞—Ç—ã. –¢–∞–∫ –∫–∞–∫ —Ç–∞–º —É–∂–µ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç —Å–∫–æ—É–ø–∞, —è –º–æ–≥—É –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ—Ä–∞ –≤ –Ω—ë–º.

–î–ª—è —ç—Ç–æ–≥–æ –µ—Å—Ç—å –Ω–æ–≤–µ–π—à–µ–µ –∞–ø–∏ `createWatch` –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–µ –≤ 22.3.0.

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: `createWatch` —Å–ª–µ–¥—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫—Ä–∞–π–Ω–µ –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∏–±–ª–∏–æ—Ç–µ—á–Ω–æ–≥–æ –∫–æ–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä `effector-react`. –ó–¥–µ—Å—å `createWatch` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞. –ü–æ —Ö–æ—Ä–æ—à–µ–º—É, —Å–ª–µ–¥—É–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç—Ç—É –ª–æ–≥–∏–∫—É –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞—Ö.

–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ—Ä–∞ –≤ —Å–∫–æ—É–ø–µ, –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∫–æ–ª–ª–±–µ–∫. –í —ç—Ç–æ–º –∫–æ–ª–ª–±–µ–∫–µ —è –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∫–æ—É–ø–∞ –∫–∞–∂–¥–æ–º—É –∞–∫—Ç–∏–≤–Ω–æ–º—É –∏–≥—Ä–æ–∫—É.

```tsx
import * as munchkin from '../common/munchkin';

// –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–¥–∏–Ω —Å—Ç–æ—Ä
createWatch({
  unit: munchkin.$players,
  scope: room.scope,
  fn: () => sendUpdates(room),
});

// –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ —Å—Ç–æ—Ä—ã –≤ –æ–±—ä–µ–∫—Ç–µ
Object.values(munchkin).forEach((unit) => {
  if (is.store(unit)) {
    createWatch({
      unit,
      scope: room.scope,
      fn: () => sendUpdates(room),
    });
  }
});

// –ø–æ–¥–ø–∏—Å–∫–∞ —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω
munchkin.common.onCreateStore((unit) => {
  createWatch({
    unit,
    scope: room.scope,
    fn: () => sendUpdates(room),
  });
});
```

–¢–∞–∫ –∫–∞–∫ –Ω–∞–º –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –º–Ω–æ–≥–æ —Å—Ç–æ—Ä–æ–≤, —Ç–æ –ø—Ä–æ—â–µ –ø–æ–º–µ—Å—Ç–∏—Ç—å –∏—Ö –≤ –µ–¥–∏–Ω—ã–π –¥–æ–º–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ —Ä–∞–∑–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è —Ö—É–∫ `onCreateStore`. –ê –µ—Å–ª–∏ –±—É–¥—É—Ç —Å—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞, —Ç–æ –æ–Ω–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –Ω–µ –≤ –¥–æ–º–µ–Ω–µ.

```tsx
function sendUpdates(room) {
  const states = serialize(room.scope);
  forEach(room.players, (player) => player.send('gameUpdate', states));
}
```

–í –±—Ä–∞—É–∑–µ—Ä–Ω–æ–º –∫–æ–¥–µ, –≤—Å–µ –¥–æ–≤–æ–ª—å–Ω–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω–æ.

–ö–æ–≥–¥–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏–ª–µ—Ç–∞—é—Ç —Å–æ–±—ã—Ç–∏—è, —è –∏—Ö —Ä–∞–∑–±–∏—Ä–∞—é –Ω–∞ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ –ø–æ–ª—é `type`. –î–ª—è —ç—Ç–æ–≥–æ –∫—Ä–∞–π–Ω–µ –ø–æ–ª–µ–∑–µ–Ω –º–µ—Ç–æ–¥ `split`

```tsx
const messageReceived = createEvent<Message>();

split({
  source: messageReceived,
  match: (message: Message) => message.type,
  cases: {
    gameUpdated,
    roomsUpdated,
    roomLeft,
    __: messageUnknown,
  },
});
```

–°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç –∫–∞–∂–¥–æ–º—É –∫–ª–∏–µ–Ω—Ç—É `gameUpdated`, –Ω–æ —Ç–æ–ª—å–∫–æ —Å —Ç–µ–º–∏ —Å—Ç–æ—Ä–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.
–ú–µ—Ç–æ–¥ `spread` –∏–∑ –ø–∞—Ç—Ä–æ–Ω—É–º –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å—Ç–æ—Ä—ã –ø–æ –∏—Ö `.sid`

```tsx
import * as munchkin from '../common/munchkin';

// —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ .sid
spread({
  source: gameUpdated,
  targets: {
    [munchkin.$players.sid]: munchkin.$players,
    [munchkin.$gameMode.sid]: munchkin.$gameMode,
  },
});

// —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–µ—Ç–æ–∫ —á–µ—Ä–µ–∑ —Ü–∏–∫–ª
spread({
  source: gameUpdated,
  targets: Object.fromEntries(
    Object.values(munchkin)
      .filter((unit) => is.store(unit))
      .map((unit) => [unit.sid, unit]),
  ),
});

// –Ω–∞ –∫–∞–∂–¥—ã–π —Å—Ç–æ—Ä —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–∏–Ω sample
munchkin.common.onCreateStore((store) => {
  sample({
    clock: gameUpdated,
    filter: (states) => typeof states[store.sid] !== 'undefined',
    target: store,
  });
});
```

–ù–æ –∏—Å–ø–æ–ª—å–∑—É—è –¥–æ–º–µ–Ω, –º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏—Å—å –∏ –±–µ–∑ `spread`. –ï—â–µ –æ–¥–∏–Ω –ø–ª—é—Å —Ö—É–∫–æ–≤.

## –í–∫—Ä–∞—Ç—Ü–µ

1. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç —Å–æ —Å–∫–æ—É–ø–∞–º–∏ –∏ —Å–ø–∏—Å–∫–æ–º –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
2. –í –±—Ä–∞—É–∑–µ—Ä–∞—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫–∞–Ω–∞–ª websocket, –ø—É–±–ª–∏—á–Ω–æ–µ API –∏–≤–µ–Ω—Ç–æ–≤ –∏ —Å—Ç–æ—Ä–æ–≤ —Å —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º–∏ –∂–µ SID, –∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
3. –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –±–µ—Ä–µ–º –µ–≥–æ `sid` –∏ payload, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ websocket –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
4. –°–µ—Ä–≤–µ—Ä –∑–Ω–∞–µ—Ç –≤ –∫–∞–∫–æ–π –∫–æ–º–Ω–∞—Ç–µ —Å–µ–π—á–∞—Å –∏–≥—Ä–æ–∫, –∏—â–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π event –ø–æ –µ–≥–æ `sid` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ `allSettled` –Ω–∞ —Å–∫–æ—É–ø–µ –∫–æ–º–Ω–∞—Ç—ã.
5. –õ–æ–≥–∏–∫–∞ –∫—Ä—É—Ç–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Å–∫–æ—É–ø–∞, –≤ —Å–ª–µ–¥—Å—Ç–≤–∏–∏ —á–µ–≥–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Å—Ç–æ—Ä—ã, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–ª–±–µ–∫ `createWatch`.
6. –í–Ω—É—Ç—Ä–∏ –∫–æ–º–Ω–∞—Ç—ã –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ websocket-–∫–∞–Ω–∞–ª—ã –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –∞ –∑–Ω–∞—á–∏—Ç –º—ã –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∫–æ—É–ø–∞ —Å –ø–æ–º–æ—â—å—é `serialize()`.
7. –ë—Ä–∞—É–∑–µ—Ä—ã –∏–≥—Ä–æ–∫–æ–≤ –ª–æ–≤—è—Ç —Å–æ–±—ã—Ç–∏–µ –ø–æ websocket-–∫–∞–Ω–∞–ª—É, –ø–∞—Ä—Å—è—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, `split` –≤—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π –Ω–∞–º –∏–≤–µ–Ω—Ç.
8. –ú–µ—Ç–æ–¥ `spread` –æ–±–Ω–æ–≤–∏—Ç —Å—Ç–æ—Ä –ø–æ –∫–ª—é—á—É –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏, –≤–µ–¥—å —ç—Ç–æ `sid`.
9. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ—Ä–æ–≤.

## –ß—Ç–æ –ø–æ–ª—É—á–∏–ª –≤ –∏—Ç–æ–≥–µ

–í –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–Ω–µ –Ω—É–∂–Ω–æ –±—ã–ª–æ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å —à–∏–Ω—É –æ–±—â–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –∏ –±—Ä–∞—É–∑–µ—Ä–æ–≤. –õ—é–±—ã–µ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ –¥–æ–º–µ–Ω–µ `munchkin` –±—É–¥—É—Ç –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∞ —Å—Ç–æ—Ä—ã –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏.

–¢–∞–∫–∂–µ typescript —Å–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã –∏ –º–Ω–µ –Ω–µ –ø—Ä–∏–¥–µ—Ç—Å—è –≤–µ—Ä–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—É –Ω–∞ —Å–ª–æ–≤–æ, –≤–µ–¥—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±—É–∫–≤–∞–ª—å–Ω–æ —Ç–æ—Ç –∂–µ –Ω–∞–±–æ—Ä –∏–≤–µ–Ω—Ç–æ–≤ –∏ —Å—Ç–æ—Ä–æ–≤. –û—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–µ–ø–ª–æ–∏—Ç—å —ç—Ç–æ –≤–º–µ—Å—Ç–µ, —á—Ç–æ–±—ã –≤–µ—Ä—Å–∏—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ –∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞ —Å–æ–≤–ø–∞–¥–∞–ª–∞, –Ω–æ —ç—Ç–æ —É–∂–µ –≤–æ–ø—Ä–æ—Å –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç—å–∏.

[–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏](https://t.me/sergeysova/675)
